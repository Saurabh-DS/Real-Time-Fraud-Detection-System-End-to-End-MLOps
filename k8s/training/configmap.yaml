apiVersion: v1
kind: ConfigMap
metadata:
  name: training-scripts
  namespace: fraud-detection
data:
  train.py: |
    """
    Robust Training Script for Kubernetes
    """
    import os
    import sys
    import logging
    import pandas as pd
    import numpy as np
    from datetime import datetime
    import xgboost as xgb
    import mlflow
    import mlflow.xgboost
    from sklearn.model_selection import train_test_split
    from sklearn.metrics import accuracy_score, precision_score, recall_score, f1_score, roc_auc_score
    
    # Configure logging
    logging.basicConfig(level=logging.INFO)
    
    MLFLOW_TRACKING_URI = os.getenv('MLFLOW_TRACKING_URI', 'http://mlflow:5000')
    EXPERIMENT_NAME = "fraud_detection"
    
    def generate_synthetic_data(n_samples=2000):
        logging.info(f"Generating {n_samples} synthetic samples...")
        np.random.seed(42)
        
        # Features
        data = {
            'amount': np.random.lognormal(3.5, 1.0, n_samples),
            'transaction_count_1h': np.random.poisson(5, n_samples),
            'velocity_score': np.random.beta(2, 5, n_samples),
            'hour_of_day': np.random.randint(0, 24, n_samples),
            'is_high_risk_merchant': np.random.binomial(1, 0.1, n_samples),
        }
        
        df = pd.DataFrame(data)
        
        # Target (Fraud)
        # Fraud logic: high amount + high velocity
        fraud_prob = (
            (df['amount'] > 200).astype(int) * 0.3 +
            (df['velocity_score'] > 0.7).astype(int) * 0.3 +
            df['is_high_risk_merchant'] * 0.2 +
            np.random.normal(0, 0.1, n_samples)
        )
        df['is_fraud'] = (fraud_prob > 0.4).astype(int)
        
        return df

    def train():
        mlflow.set_tracking_uri(MLFLOW_TRACKING_URI)
        mlflow.set_experiment(EXPERIMENT_NAME)
        
        logging.info("Starting training pipeline...")
        
        # Load Data
        df = generate_synthetic_data()
        X = df.drop('is_fraud', axis=1)
        y = df['is_fraud']
        
        X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)
        
        with mlflow.start_run(run_name=f"retrain_{datetime.now().strftime('%Y%m%d_%H%M')}") as run:
            params = {
                'objective': 'binary:logistic',
                'max_depth': 4,
                'learning_rate': 0.1,
                'n_estimators': 100,
                'eval_metric': 'logloss'
            }
            mlflow.log_params(params)
            
            # Train
            model = xgb.XGBClassifier(**params)
            model.fit(X_train, y_train)
            
            # Eval
            y_pred = model.predict(X_test)
            metrics = {
                'accuracy': accuracy_score(y_test, y_pred),
                'precision': precision_score(y_test, y_pred, zero_division=0),
                'recall': recall_score(y_test, y_pred, zero_division=0),
                'f1': f1_score(y_test, y_pred, zero_division=0),
                'roc_auc': roc_auc_score(y_test, y_pred)
            }
            
            mlflow.log_metrics(metrics)
            logging.info(f"Metrics: {metrics}")
            
            # Log Model
            mlflow.xgboost.log_model(model, "model", registered_model_name="fraud_detection_model")
            logging.info(f"Model saved to MLflow Run: {run.info.run_id}")
            
    if __name__ == "__main__":
        train()
